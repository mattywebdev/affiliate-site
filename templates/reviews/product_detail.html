{% extends "base.html" %}
{% load ratings %}
{% block content %}

<style>
  .product-wrap { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
  .card { border:1px solid #ddd; border-radius:12px; padding:16px; }
  .muted { color:#666; }
  .stars { display:flex; gap:4px; align-items:center; font-size:20px; line-height:1; }
  .star { color:#1a8f3a; }      /* green */
  .star-empty { color:#cfcfcf; }
  .buy { display:inline-block; padding:10px 14px; border:1px solid #1a8f3a; border-radius:10px; text-decoration:none; }
  .buy:hover { background:#f3fff7; }
  .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  ul.clean { margin:10px 0 0; padding-left:18px; }
  .section-title { margin: 18px 0 10px; }
</style>

<h1 style="margin-bottom:10px;">{{ product.name }}</h1>

<div class="product-wrap">
  <div class="card">
    {% if product.image %}
      <img src="{{ product.image.url }}" alt="{{ product.name }}"
           style="width:100%; height:220px; object-fit:cover; border-radius:12px;">
    {% elif product.amazon_image_url %}
    <img src="{{ product.amazon_image_url }}" alt="{{ product.name }}">
    {% else %}
    <div class="img-placeholder">No image</div>
    {% endif %}

    <div style="margin-top:12px;">
      <div class="stars" aria-label="Rating {{ product.rating }} out of 5">
        {% star_states product.rating as stars %}
        {% for s in stars %}
          {% if s == "full" %}
            <span class="star">★</span>
          {% elif s == "half" %}
            <span class="star">⯪</span>
          {% else %}
            <span class="star-empty">★</span>
          {% endif %}
        {% endfor %}
        <span class="muted" style="font-size:14px; margin-left:6px;">
          {{ product.rating }}/5
        </span>
      </div>

      {% if product.category %}
        <p class="muted" style="margin:10px 0 0;">
          Category:
          <a href="{% url 'reviews:category_detail' product.category.slug %}">
            {{ product.category.name }}
          </a>
        </p>
      {% endif %}

      <p style="margin:10px 0 0; font-size:20px;"><strong>£{{ product.price }}</strong></p>

      <p style="margin:14px 0 0;">
        <a class="buy" href="{% url 'reviews:affiliate_redirect' product.slug %}" target="_blank" rel="noopener">
          Buy on Amazon →
        </a>
      </p>
    </div>
  </div>

  <div>
    <div class="card">
      <h2 style="margin:0 0 10px;">Overview</h2>
      <p style="margin:0;">{{ product.description }}</p>
    </div>

    <div class="two-col" style="margin-top:16px;">
      <div class="card">
        <h3 style="margin:0;">Pros</h3>
        {% if product.pros %}
          <ul class="clean">
            {% for line in product.pros.splitlines %}
              {% if line %}<li>{{ line }}</li>{% endif %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted" style="margin:10px 0 0;">No pros added yet.</p>
        {% endif %}
      </div>

      <div class="card">
        <h3 style="margin:0;">Cons</h3>
        {% if product.cons %}
          <ul class="clean">
            {% for line in product.cons.splitlines %}
              {% if line %}<li>{{ line }}</li>{% endif %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted" style="margin:10px 0 0;">No cons added yet.</p>
        {% endif %}
      </div>
    </div>

    {% if related_articles %}
      <h3 class="section-title">Articles mentioning this product</h3>
      <div class="card">
        {% for article in related_articles %}
          <div style="margin-bottom:10px;">
            <a href="{% url 'reviews:article_detail' article.slug %}">{{ article.title }}</a>
            {% if article.excerpt %}
              <div class="muted" style="font-size:14px;">{{ article.excerpt|truncatechars:120 }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if related_products %}
      <h3 class="section-title">Related products</h3>
      {% for p in related_products %}
        <div class="card" style="margin-bottom:12px;">
          <strong><a href="{% url 'reviews:product_detail' p.slug %}">{{ p.name }}</a></strong>
          <div class="muted">£{{ p.price }}</div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
</div>

<p style="margin-top:18px;">
  <a href="{% url 'reviews:product_list' %}">← Back to Product List</a>
</p>

{% endblock %}
